const path = require('path');

module.exports = {
  tags: (tln) => [],
  options: (tln, options) => {},
  dotenvs: (tln) => [],
  depends: (tln) => [],
  inherits: (tln) => [],
  variables: (tln, variables) => {
    variables
      .set('JAVA_HOME', (tln, data) => data.env['COMPONENT_ORIGIN'])
      .prepend('PATH', (tln, data) => `${data.env['COMPONENT_ORIGIN']}${data.sep}bin`);
  },
  steps: (tln) => [
    {
      id: 'install',
      filter: '',
      script: (tln, script) => {
        const osInfo = tln.getOsInfo();
        const platform = osInfo.platform;
        const id = script.env["COMPONENT_ID"];
        //
        defaultDistrs = {
          'default-jre': {
            'ubuntu': ['sudo apt-get install -y default-jre'],
            'centos': ['sudo yum install java-jre']
          },
          'default-jdk': {
            'ubuntu': ['sudo apt-get install -y default-jdk'],
            'centos': ['sudo yum install java-sdk']
          }
        };
        if (defaultDistrs[id]) {
          Object.keys(defaultDistrs[id]).forEach( k => {
            if (tln.filter.validate(k)) {
              script.set(defaultDistrs[id][k]);
            }
          });
        } else {
          const distrs = {
            'openjdk-9.0.4': {
              'linux': {'name': 'openjdk-9.0.4_linux-x64_bin.tar.gz', 'folder': '', 'url': 'https://download.java.net/java/GA/jdk9/9.0.4/binaries/openjdk-9.0.4_linux-x64_bin.tar.gz'},
              'darwin': {'name': 'openjdk-9.0.4_osx-x64_bin.tar.gz', 'folder': 'jdk-9.0.4.jdk/Contents/Home', 'url': 'https://download.java.net/java/GA/jdk9/9.0.4/binaries/openjdk-9.0.4_osx-x64_bin.tar.gz'},
              'win32': {'name': 'openjdk-9.0.4_windows-x64_bin.tar.gz', 'folder': 'jdk-9.0.4', 'url': 'https://download.java.net/java/GA/jdk9/9.0.4/binaries/openjdk-9.0.4_windows-x64_bin.tar.gz'}
            },
            'openjdk-10.0.2': {
              'linux': {'name': 'openjdk-10.0.2_linux-x64_bin.tar.gz', 'folder':'', 'url': 'https://download.java.net/java/GA/jdk10/10.0.2/19aef61b38124481863b1413dce1855f/13/openjdk-10.0.2_linux-x64_bin.tar.gz'},
              'darwin': {'name': 'openjdk-10.0.2_osx-x64_bin.tar.gz', 'folder':'jdk-10.0.2.jdk/Contents/Home', 'url': 'https://download.java.net/java/GA/jdk10/10.0.2/19aef61b38124481863b1413dce1855f/13/openjdk-10.0.2_osx-x64_bin.tar.gz'},
              'win32': {'name': 'openjdk-10.0.2_windows-x64_bin.tar.gz', 'folder':'jdk-10.0.2', 'url': 'https://download.java.net/java/GA/jdk10/10.0.2/19aef61b38124481863b1413dce1855f/13/openjdk-10.0.2_windows-x64_bin.tar.gz'}
            },
            'openjdk-11.0.2': {
              'linux': {'name': 'openjdk-11.0.2_linux-x64_bin.tar.gz', 'folder':'', 'url': 'https://download.java.net/java/GA/jdk11/9/GPL/openjdk-11.0.2_linux-x64_bin.tar.gz'},
              'darwin': {'name': 'openjdk-11.0.2_osx-x64_bin.tar.gz', 'folder':'jdk-11.0.2.jdk/Contents/Home', 'url': 'https://download.java.net/java/GA/jdk11/9/GPL/openjdk-11.0.2_osx-x64_bin.tar.gz'},
              'win32': {'name': 'openjdk-11.0.2_windows-x64_bin.zip', 'folder':'jdk-11.0.2', 'url': 'https://download.java.net/java/GA/jdk11/9/GPL/openjdk-11.0.2_windows-x64_bin.zip'}
            },
            'openjdk-12.0.2': {
              'linux': {'name': 'openjdk-12.0.2_linux-x64_bin.tar.gz', 'folder':'', 'url': 'https://download.java.net/java/GA/jdk12.0.2/e482c34c86bd4bf8b56c0b35558996b9/10/GPL/openjdk-12.0.2_linux-x64_bin.tar.gz'},
              'darwin': {'name': 'openjdk-12.0.2_osx-x64_bin.tar.gz', 'folder':'jdk-12.0.2.jdk/Contents/Home', 'url': 'https://download.java.net/java/GA/jdk12.0.2/e482c34c86bd4bf8b56c0b35558996b9/10/GPL/openjdk-12.0.2_osx-x64_bin.tar.gz'},
              'win32': {'name': 'openjdk-12.0.2_windows-x64_bin.zip', 'folder':'jdk-12.0.2', 'url': 'https://download.java.net/java/GA/jdk12.0.2/e482c34c86bd4bf8b56c0b35558996b9/10/GPL/openjdk-12.0.2_windows-x64_bin.zip'}
            }
          };
          if (distrs[id][platform]) {
            const folder = distrs[id][platform].folder;
            const name = distrs[id][platform].name;
            const url = distrs[id][platform].url;
            //
            if (platform === 'win32') {
              let extractor = `powershell -Command "Expand-Archive -LiteralPath ${name} -DestinationPath ."`;
              if (name.match('tar.gz')) {
                extractor = `tar -xvzf ${name}`;
              }
              script.set([
                `powershell -Command "(New-Object System.Net.WebClient).DownloadFile('${url}', '${name}')"`,
                extractor,
                `powershell -Command "Move-Item -Path '${folder}\\*' -Destination ."`,
                `powershell -Command "Remove-Item '${folder}'"`,
                `powershell -Command "Remove-Item '${name}'"`
              ]);
            } else if (platform === 'linux') {
              script.set([
                `wget '${url}'`,
                `tar --strip-components=1 -xzf '${name}'`,
                `rm -f ${name}`,
              ]);
            } else if (platform === 'darwin') {
              const folder2remove = folder.split(path.sep)[0];
              script.set([
                `wget '${url}'`,
                `tar -xzf '${name}'`,
                `mv ${folder}/* .`,
                `rm -f ${name}`,
                `rm -fR ${folder2remove}`
              ]);
            }
          }
        }
      }
    }
  ],
  components: (tln) => [
    { id: 'default-jre' },
    { id: 'default-jdk' },
    { id: 'openjdk-9.0.4' },
    { id: 'openjdk-10.0.2' },
    { id: 'openjdk-11.0.2' },
    { id: 'openjdk-12.0.2' }
  ]
}