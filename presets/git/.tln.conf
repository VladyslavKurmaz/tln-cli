'use strict';

const path = require('path');
const fs = require('fs');

class Subtree {


  constructor() {
    this.subtreesFileName = '.gitsubtrees';
  }

  clone(context) {
    context.setScript([
      `git clone ${context.env.TLN_GIT_ORIGIN} .`,
      `git config --local user.name "${context.env.TLN_GIT_USER}"`,
      `git config --local user.email "${context.env.TLN_GIT_EMAIL}"`
    ]);
  }

  fork(context) {
    context.setScript([
      `git clone ${context.env.TLN_GIT_ORIGIN} .`,
      `git remote add upstream ${context.env.TLN_GIT_UPSTREAM}`,
      `git config --local user.name "${context.env.TLN_GIT_USER}"`,
      `git config --local user.email "${context.env.TLN_GIT_EMAIL}"`
    ]);
  }

  getSubtreesFileName(home) {
    return path.join(home, this.subtreesFileName);
  }

  loadSubtrees(home) {
    const fn = this.getSubtreesFileName(home);
    let r = [];
    if (fs.existsSync(fn)) {
      r = JSON.parse(fs.readFileSync(fn, 'utf8'));
    }
    return r;
  }

  saveSubtrees(home, subtrees) {
    fs.writeFileSync(this.getSubtreesFileName(home), JSON.stringify(subtrees, null, '  '));
  }

  lsSubtree(context) {
    const home = context.env.COMPONENT_HOME;
    //
    context.logger.con('Prefix'.padEnd(16), 'Origin'.padEnd(48), 'Ref');
    this.loadSubtrees(home).forEach(elem => context.logger.con(elem.prefix.padEnd(16), elem.origin.padEnd(48), elem.ref));
  }

  addSubtree(context) {
    const home = context.env.COMPONENT_HOME;
    const prefix = context.env.TLN_GIT_PREFIX;
    const origin = context.env.TLN_GIT_ORIGIN;
    const ref = context.env.TLN_GIT_REF;
    //
    let subtrees = this.loadSubtrees(home);
    let subtree = subtrees.find(elem => elem.prefix === prefix);
    if (subtree) {
      context.logger.error(`Subtree with prexix: ${prefix} and origin: ${origin} was already added`);
    } else {
      subtree = {
        prefix: prefix,
        origin: origin,
        ref: ref
      };
      subtrees.push(subtree);
      this.saveSubtrees(home, subtrees);
      context.setScript([
        `git add ${this.subtreesFileName}`,
        `git commit -m"New subtree with prefix: ${subtree.prefix} and origin: ${subtree.origin} was added"`,
        `git subtree add --prefix ${subtree.prefix} ${subtree.origin} ${subtree.ref} --squash`
      ]);
    }
  }

  pullSubtree(context) {
    const home = context.env.COMPONENT_HOME;
    const prefix = context.env.TLN_GIT_PREFIX;
    const ref = context.env.TLN_GIT_REF;
    //
    let subtrees = this.loadSubtrees(home);
    let subtree = subtrees.find(elem  => elem.prefix === prefix);
    if (subtree) {
      if (ref) {
        subtree.ref = ref;
      }
      this.saveSubtrees(home, subtrees);
      context.setScript([
        `git add ${this.subtreesFileName} || true`,
        `git commit -m"Update subtree with prefix: ${subtree.prefix} and origin: ${subtree.origin}" || true`,
        `git subtree pull --prefix ${subtree.prefix} ${subtree.origin} ${subtree.ref} --squash`
      ]);
    } else {
      context.logger.error(`Subtree with prefix: ${prefix} was not found`);
    }
  }

}


module.exports = {
  tags: (context) => [],
  options: (context) => [
    { id: 'origin',   desc: 'Origin url',               variable: 'TLN_GIT_ORIGIN',   default: null },
    { id: 'upstream', desc: 'Upstream remote url',      variable: 'TLN_GIT_UPSTREAM', default: null },
    { id: 'ref',      desc: 'Ref',                      variable: 'TLN_GIT_REF',      default: null },
    { id: 'user',     desc: 'User name',                variable: 'TLN_GIT_USER',     default: null },
    { id: 'email',    desc: 'User email',               variable: 'TLN_GIT_EMAIL',    default: null },
    { id: 'prefix',   desc: 'Submodule/subtree prefix', variable: 'TLN_GIT_PREFIX',   default: null }
  ],
  inherits: (context) => [],
  depends: (context) => [],
  variables: (context) => [],
  steps: (context) => [
    {
      id: 'git-clone',
      desc: '\
Clone git repository and configure user, \
example: tln git-clone --origin=git@github.com:org/proj.git --user=user --email=user@org.com',
      script: (context) => (new Subtree).clone(context)
    },
    {
      id: 'git-fork',
      desc: '\
Clone git repository, add additional remote (upstream) and configure user, \
example: tln git-fork --origin=git@github.com:user/proj.git --upstream=git@github.com:org/proj.git --user=user --email=user@org.com',
      script: (context) => (new Subtree).fork(context)
    },
    {
      id: 'git-subtree-ls',
      desc: '\
List registered subtrees, \
example: tln git-subtree-ls',
      script: (context) => (new Subtree).lsSubtree(context)
    },
    {
      id: 'git-subtree-add',
      desc: '\
Add subtree to the project, \
example: tln git-subtree-add --origin=https://github.com/project-talan/tln-nodejs.git --prefix=services/api --ref=master',
      script: (context) => (new Subtree).addSubtree(context)
    },
    {
      id: 'git-subtree-pull',
      desc: '\
Pull subtree, \
example: tln git-subtree-pull --prefix=services/api [--ref=master]',
      script: (context) => (new Subtree).pullSubtree(context)
    }
  ],
  components: (context) => []
}